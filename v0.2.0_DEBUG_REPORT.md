# VerTac v0.2.0 Debug Report

**Date:** January 11, 2026  
**Scope:** Complete system review before initial commit  
**Files Reviewed:** 16 files (~4,500 lines)

---

## üêõ CRITICAL BUGS

### 1. Duplicate Import in `backend/live/routes.py`
**Severity:** HIGH  
**Location:** Lines 9 and 13  
**Issue:** `from datetime import datetime` is imported twice  
**Impact:** Redundant code, potential IDE warnings  
**Fix:** Remove line 13

```python
# Current (lines 9-13):
from datetime import datetime
import json
from typing import Dict, List, Optional
import uuid
from datetime import datetime  # ‚ùå DUPLICATE

# Fixed:
from datetime import datetime
import json
from typing import Dict, List, Optional
import uuid
```

---

## ‚ö†Ô∏è MISSING DEPENDENCIES

### 2. Missing `influxdb-client` in `backend/requirements.txt`
**Severity:** CRITICAL  
**Location:** `backend/requirements.txt`  
**Issue:** `backend/services/influxdb_manager.py` imports `from influxdb_client import InfluxDBClient` but the package is not in requirements.txt  
**Impact:** Backend will fail to start with ImportError  
**Fix:** Add to requirements.txt:
```
influxdb-client==1.38.0
```

### 3. Missing `websockets` in `backend/requirements.txt`
**Severity:** HIGH (if not included in uvicorn[standard])  
**Location:** `backend/requirements.txt`  
**Issue:** WebSocket support needed for `@router.websocket()` endpoints  
**Status:** Check if `uvicorn[standard]` includes WebSocket support (it likely does)  
**Fix:** Verify or add explicitly:
```
websockets==12.0
```

---

## üîß PYTHON IMPORT PATH ISSUES

### 4. Relative Imports Require `__init__.py` Files
**Severity:** CRITICAL  
**Location:** Multiple files  
**Issue:** `backend/live/routes.py` uses relative imports:
```python
from services.cycle_state_machine import CycleStateMachine
from services.influxdb_manager import InfluxDBManager
from services.deviation_analyzer import DeviationAnalyzer
```

But the following `__init__.py` files are **MISSING**:
- `backend/__init__.py`
- `backend/services/__init__.py`
- `backend/live/__init__.py`

**Impact:** Python will not recognize these as packages, causing ImportError  
**Fix:** Create empty `__init__.py` files in:
```
backend/__init__.py
backend/services/__init__.py
backend/live/__init__.py
```

Alternatively, use absolute imports from project root:
```python
from backend.services.cycle_state_machine import CycleStateMachine
```

---

## üì¶ CONFIGURATION ISSUES

### 5. InfluxDB Configuration Incomplete
**Severity:** HIGH  
**Location:** `backend/live/routes.py` lines 25-29  
**Issue:** InfluxDBManager instantiated with placeholder values:
```python
influxdb_manager = InfluxDBManager(
    url="http://localhost:8086",
    token="default-token",  # ‚ùå Placeholder
    org="vertac",
    bucket="sensor_readings"
)
```

**Impact:** Backend cannot connect to InfluxDB with invalid token  
**Fix:** 
1. Read from environment variables (recommended):
```python
import os
influxdb_manager = InfluxDBManager(
    url=os.getenv("INFLUXDB_URL", "http://localhost:8086"),
    token=os.getenv("INFLUXDB_TOKEN", "your-token"),
    org=os.getenv("INFLUXDB_ORG", "vertac"),
    bucket=os.getenv("INFLUXDB_BUCKET", "sensor_readings")
)
```

2. Add to `.env`:
```
INFLUXDB_TOKEN=your-actual-token
```

---

## üìä DATA INTEGRITY ISSUES

### 6. Incorrect Sample ID Extraction in Retry Logic
**Severity:** MEDIUM  
**Location:** `edge-connector/connector.py` line 451  
**Issue:**
```python
sample_ids = [int(s.sensor_id) for s in unacked]
```

This tries to convert `sensor_id` (UUID string) to int for marking as acknowledged.  
**Expected:** Should use database row IDs, not sensor_ids  
**Impact:** Retry acknowledgment will fail, causing repeated sends  
**Fix:** Modify `LocalBuffer.get_unacked_samples()` to return row IDs:
```python
def get_unacked_samples(self, limit: int = 100) -> List[tuple]:
    """Retrieve unacknowledged samples with row IDs"""
    with sqlite3.connect(self.db_path) as conn:
        conn.row_factory = sqlite3.Row
        rows = conn.execute("""
            SELECT * FROM samples WHERE acked = 0 
            ORDER BY created_at ASC LIMIT ?
        """, (limit,)).fetchall()
        
        return [
            (
                row['id'],  # Include row ID
                SensorReading(
                    timestamp=row['timestamp'],
                    sensor_id=row['sensor_id'],
                    sensor_name=row['sensor_name'],
                    value=row['value'],
                    unit=row['unit'],
                    quality=row['quality']
                )
            )
            for row in rows
        ]
```

Then update retry logic:
```python
unacked_with_ids = self.buffer.get_unacked_samples(limit=100)
if unacked_with_ids:
    sample_ids, readings = zip(*unacked_with_ids)
    if await self.send_batch(list(readings)):
        self.buffer.mark_acked(list(sample_ids))
```

---

## üîå API INTEGRATION ISSUES

### 7. Query Parameter vs Request Body Inconsistency
**Severity:** MEDIUM  
**Location:** `backend/live/routes.py` lines 215-217, 232-234  
**Issue:** `/cycle/start` and `/cycle/stop` endpoints use query parameters but should use request body or path parameters  

**Current:**
```python
@router.post("/cycle/start")
async def start_cycle(stream_id: str, cycle_metadata: Optional[Dict] = Body(None)):
```

**Problem:** `stream_id` as query param is unclear  
**Fix:** Use path parameter:
```python
@router.post("/cycle/start/{stream_id}")
async def start_cycle(stream_id: str, cycle_metadata: Optional[Dict] = Body(None)):
```

Same for `/cycle/stop`.

---

## üåê FRONTEND-BACKEND MISMATCH

### 8. WebSocket URL Path Mismatch (POTENTIAL)
**Severity:** LOW (verify)  
**Location:** 
- Frontend: `frontend/src/components/Live/LiveMonitoring.tsx` line ~55
- Backend: `backend/live/routes.py` line 268

**Frontend:**
```typescript
const ws = new WebSocket(`ws://localhost:8000/api/live/ws/stream/${streamId}`);
```

**Backend:**
```python
@router.websocket("/ws/stream/{stream_id}")
```

**Issue:** If router is mounted at `/api/live`, paths match. But verify router mounting in main.py  
**Required Check:** Ensure backend `main.py` includes:
```python
app.include_router(live_routes.router, prefix="/api/live")
```

---

## üóÑÔ∏è DATABASE SCHEMA ISSUES

### 9. Missing Database Migrations/Schema Creation
**Severity:** HIGH  
**Location:** Documentation mentions new tables but no schema files provided  
**Issue:** `ARCHITECTURE_v0.2.0.md` mentions new PostgreSQL tables:
- `live_streams`
- `live_cycles`
- `live_deviations`
- `live_alerts`

But no SQL migration files or SQLAlchemy models provided.

**Impact:** Backend expects database tables that don't exist  
**Fix:** Create Alembic migration or add table creation in init script:
```sql
-- backend/migrations/v0.2.0_live_tables.sql
CREATE TABLE IF NOT EXISTS live_streams (
    id UUID PRIMARY KEY,
    dataset_id UUID REFERENCES datasets(id),
    device_name VARCHAR(255),
    status VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS live_cycles (
    id UUID PRIMARY KEY,
    stream_id UUID REFERENCES live_streams(id),
    cycle_number INT,
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    sample_count INT,
    health_score FLOAT,
    anomaly_flag BOOLEAN,
    status VARCHAR(50)
);

CREATE TABLE IF NOT EXISTS live_deviations (
    id UUID PRIMARY KEY,
    cycle_id UUID REFERENCES live_cycles(id),
    sensor_id VARCHAR(255),
    euclidean_distance FLOAT,
    dtw_distance FLOAT,
    severity VARCHAR(50)
);

CREATE TABLE IF NOT EXISTS live_alerts (
    id UUID PRIMARY KEY,
    cycle_id UUID REFERENCES live_cycles(id),
    severity VARCHAR(50),
    message TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## üîê SECURITY CONCERNS

### 10. No Authentication on Live Endpoints
**Severity:** MEDIUM  
**Location:** All routes in `backend/live/routes.py`  
**Issue:** No authentication/authorization checks  
**Impact:** Anyone can register streams, ingest data, start/stop cycles  
**Recommendation:** Add authentication middleware or dependency injection:
```python
from fastapi import Depends
from app.auth import get_current_user

@router.post("/register", dependencies=[Depends(get_current_user)])
```

---

## üß™ TESTING GAPS

### 11. No Unit Tests for New Components
**Severity:** MEDIUM  
**Location:** All v0.2.0 code  
**Issue:** No test files created for:
- `CycleStateMachine`
- `DeviationAnalyzer`
- `InfluxDBManager`
- Edge connector
- API routes

**Recommendation:** Add test files before production deployment

---

## üìù DOCUMENTATION ISSUES

### 12. Incomplete Quickstart Script
**Severity:** LOW  
**Location:** `quickstart.sh`  
**Issue:** Need to verify if script:
- Creates `.env` file if missing
- Sets up InfluxDB admin token
- Initializes database schemas
- Handles first-run setup

---

## ‚úÖ VERIFIED WORKING COMPONENTS

The following components passed review with no critical issues:

1. ‚úÖ **Edge Connector Core Logic** - Retry, buffering, batch sending looks solid
2. ‚úÖ **Cycle State Machine** - State transitions and event handling are correct
3. ‚úÖ **Deviation Analyzer** - Signal processing logic is sound
4. ‚úÖ **Frontend Components** - React/TypeScript structure is good
5. ‚úÖ **Docker Compose** - Service definitions are correct
6. ‚úÖ **Documentation** - Architecture docs are comprehensive

---

## üéØ PRIORITY FIX ORDER

### Must Fix Before Commit:
1. ‚úÖ Remove duplicate datetime import (routes.py line 13)
2. ‚úÖ Add `influxdb-client` to backend/requirements.txt
3. ‚úÖ Create `__init__.py` files for Python packages
4. ‚úÖ Fix edge connector retry logic (sample IDs)
5. ‚úÖ Update InfluxDB config to use env variables

### Should Fix Before Testing:
6. ‚ö†Ô∏è Create database schema migration
7. ‚ö†Ô∏è Fix cycle start/stop API path parameters
8. ‚ö†Ô∏è Verify WebSocket path mounting
9. ‚ö†Ô∏è Add basic authentication

### Nice to Have:
10. üí° Add unit tests
11. üí° Improve quickstart script
12. üí° Add logging configuration

---

## üìä SUMMARY

- **Total Issues Found:** 13
- **Critical:** 6 (imports, dependencies, package structure, DB schema, **ROUTER NOT MOUNTED**)
- **High:** 2 (config, data integrity)
- **Medium:** 3 (API design, auth, testing)
- **Low:** 2 (docs, verification)

**Estimated Fix Time:** 2-3 hours

**Recommendation:** Fix critical issues (1-6) immediately, then commit as v0.2.0-alpha. Address remaining issues in subsequent patches.

---

## üö® ADDITIONAL CRITICAL ISSUE FOUND

### 13. Live Routes Not Mounted in Main Application ‚ö†Ô∏è **CRITICAL**
**Severity:** CRITICAL  
**Location:** `backend/main.py`  
**Issue:** The new `live.routes` router is NOT included in the main FastAPI application

**Current State:**
```python
# backend/main.py only includes:
app.include_router(api_router, prefix="/api/v1")

# But api_router in backend/app/api/v1/router.py only includes:
api_router.include_router(datasets.router, prefix="/datasets", tags=["datasets"])
api_router.include_router(cycles.router, prefix="/cycles", tags=["cycles"])
api_router.include_router(analysis.router, prefix="/analysis", tags=["analysis"])

# ‚ùå MISSING: live.routes is not included!
```

**Impact:** 
- All live monitoring endpoints will return 404
- Edge connector cannot register streams
- WebSocket connections will fail
- Live monitoring features completely non-functional

**Fix Required:**
Add to `backend/main.py`:
```python
from live.routes import router as live_router

# After existing routers:
app.include_router(live_router, prefix="/api/live", tags=["live"])
```

Or add to `backend/app/api/v1/router.py`:
```python
from live import routes as live_routes

api_router.include_router(live_routes.router, prefix="/live", tags=["live"])
```
